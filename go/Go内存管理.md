# Go内存管理

1. TCMalloc(Thread Cache Malloc)

   由谷歌开发的内存管理库, 用于多线程内存管理

   为每个线程预分配一块缓存，线程申请小内存时，可以从缓存分配内存，这样有2个好处：

   1.  为线程预分配缓存需要进行1次系统调用，后续线程申请小内存时直接从缓存分配，都是在用户态执行的，没有了系统调用，缩短了内存总体的分配和释放时间，这是快速分配内存的第二个层次。
   2.  多个线程同时申请小内存时，从各自的缓存分配，访问的是不同的地址空间，从而无需加锁，把内存并发访问的粒度进一步降低了，这是快速分配内存的第三个层次。

<img src="/home/halo/notes/TCMalloc.jpg" style="zoom:150%;" />

Page: 操作系统页面

Span: 一组连续的Page为一个Span, 是内存管理的基本单位

ThreadCache: 每个线程自己的cache, 为一个空闲链表

CentralCache: 线程共享的空闲链表, 数量和Thread一样, 线程自己的cache不够和他拿, 太多就放回去

PageHeap: 内存的抽象, 也是链表, CentalCache从其中获取空闲span



分大对象(>1MB), 中对象(257KB-1MB), 小对象(0-256KB) 